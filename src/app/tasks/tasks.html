<div class="container-fluid">
    <div class="row">
        <div class="col-xs-4">
            <button class="btn btn-primary" *ngIf="user.admin>0" (click)="openModal()">Add Task</button>
        </div>
        <div class="col-xs-4">
            <input autocomplete="off" class="form-control" [(ngModel)]="filterTask">
        </div>
        <div class="col-xs-4">
            <button class="btn btn-default" (click)="fetchTasks()"><i class="glyphicon glyphicon-refresh"></i></button>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-xs-3">Task</div>
        <div class="col-xs-2">Assigned To</div>
        <div class="col-xs-2">Customer</div>
        <div class="col-xs-2">Due On</div>
        <div class="col-xs-2">Sequence</div>
    </div>
    <div class="row mb-4" *ngFor="let task of tasks | filterTasks:filterTask" (click)="openModal(task)">
        <div class="col-xs-3"><strong class="text-muted">{{(""+task.description).substring(0,30)}}</strong></div>
        <div class="col-xs-2"><i class="text-muted">{{task.user?task.user.name:"**Not Assigned**"}}</i></div>
        <div class="col-xs-2"><i class="text-muted">{{(task.customer)? task.customer.name:"**Not Assigned**"}}</i></div>
        <div class="col-xs-2"><i class="text-muted">{{task.nextDueDate |  date:'MMM,dd yyyy' }}</i></div>
        <div class="col-xs-2"><strong class="text-muted">{{task.sequence}}</strong></div>
    </div>
</div> 

<ng-template #template>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Add Task</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <form class="container-fluid well well-default" #taskForm="ngForm">
            <div class="form-group">
                <textarea class="form-control" name="description" required [(ngModel)]="currentTask.description" placeholder="Description"></textarea>
            </div>
            
            <div class="form-group">
                <label>Due On <input type="date" class="form-control" name="dueDate" required [(ngModel)]="currentTask.nextDueDate" placeholder="Task Due On"></label>
            </div>
            <div class="form-group">
                <label>Sequence<input type="number" class="form-control" name="sequence" required [(ngModel)]="currentTask.sequence" placeholder="Sequence number"></label>
            </div>
            
            <div class="form-group">
                <select class="form-control" name="taskType" required [(ngModel)]="currentTask.type">
                    <option value="undefined" disabled>Select Task Type</option>
                    <option [ngValue]="type.value" *ngFor="let type of taskTypes">{{type.text}}</option>
                </select>
            </div>
            <div *ngIf="currentTask.type==2">
                <label>Amount <input class="form-control" required type="number" name="amount" [(ngModel)]="currentTask.amount"></label>
            </div>
            <label>Select User
                <input  autocomplete="off" name="user"
                (change)="currentTask.user = undefined"
                required
                (typeaheadOnSelect)="currentTask.user = $event.item"
                [(ngModel)]="currentTask.userName"
                placeholder="Assign Task To"
                typeaheadOptionField="name"
                [typeahead]="users"
                class="form-control">
            </label>
            
            <label>Select Customer
                <input  autocomplete="off" name="customer" 
                (change)="currentTask.customer = undefined"
                required
                (typeaheadOnSelect)="currentTask.customer = $event.item"
                [(ngModel)]="currentTask.customerName"
                placeholder="Select Customer"
                [typeahead]="customers"
                typeaheadOptionField="name_mobile"
                class="form-control">
            </label>
            
            
            <div class="form-group">
                <button [disabled]="!taskForm.valid || !currentTask.customer || !currentTask.user" (click)="createOrUpdateTask(currentTask)"
                class="btn btn-primary">
                {{currentTask.id?'Update':'Save'}}
            </button>
            <button [disabled]="!currentTask.id" (click)="deleteTask(currentTask)" class="btn btn-danger">Delete</button>
            <button (click)="modalRef.hide()" class="btn btn-default">Close</button>
            
            
            
        </div>
    </form>
</div>

</ng-template>



<ng-template #templateCompleteTask>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Task Complete</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <form #completionForm="ngForm" class="modal-body">
        <accordion closeOthers="true">
            <accordion-group heading="Step 1" isDisabled="true" [isOpen]="openPaneIndex==0">
                <div class="well well-default">
                    <h5>Description: <i class="text-muted">{{currentTask.description}}</i></h5>
                    <h5>Customer Details:
                        <h5>
                            <strong>Name</strong>: <i class="text-muted">{{currentTask.customer.name}}</i>
                        </h5>
                        <h5>
                            <strong>Mobile</strong>: <i class="text-muted">{{currentTask.customer.mobile}}</i>
                        </h5>
                        <h5>
                            <strong>Address</strong>: <i class="text-muted">{{currentTask.customer.address}}</i>
                        </h5>
                    </h5>
                </div>
                <hr>
                <div *ngIf="currentTask.type == 0">
                    <label>Select Payment Status
                        <select class="form-control" required name="paymentStatus" [(ngModel)]="completionInfo.paymentStatus">
                            <option value="" disabled>Select One</option>
                            <option [ngValue]="0">AMC</option>
                            <option [ngValue]="1">Under Warrenty</option>
                            <option [ngValue]="2">Payable</option>
                        </select>
                    </label>
                </div>
                <div *ngIf="completionInfo.paymentStatus == 2 || currentTask.type == 2">
                    <label>Amount Payable
                        <input required [disabled]="currentTask.type==2" autocomplete="off" type="number" name="amount" #amount="ngModel" required min="0" [(ngModel)]="currentTask.amount" class="form-control">
                    </label>
                </div>
                <div *ngIf="completionInfo.paymentStatus == 2 || currentTask.type == 2">
                    <label>Amount Received
                        <input type="number" class="form-control" required name="amountPaid" #amountPaid="ngModel" [(ngModel)]="completionInfo.paid">
                    </label>
                </div>
                <!-- if task was a project, then ask if it is complete or not?
                    if not when is the next visit required? -->
                    <div *ngIf="currentTask.type == 3">
                        <hr>
                        <label>Is Project Complete
                            <input type="checkbox"  name="isProjectComplete" [(ngModel)]="completionInfo.completed">
                        </label>
                        <hr>
                        <label *ngIf="!completionInfo.completed">Next Visit Required On
                            <input type="date" required class="form-control" name="nextVisitRequiredOn" [(ngModel)]="currentTask.nextDueDate">
                        </label>
                    </div>
                    <div>
                        <button [disabled]="!completionForm.valid" class="btn btn-success pull-right" (click)="taskCompleted(currentTask,completionInfo)">Finish</button>
                    </div>
                    
                </accordion-group>
            </accordion>
        </form>
    </ng-template>